<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR Verbs Anki（présent / 全覆盖）</title>
  <style>
    :root{
      --bg:#0b0c10;
      --text:#e8eaf0;
      --muted:#a8adbd;
      --line:rgba(255,255,255,.10);
      --good:#2bd576;
      --bad:#ff4d4f;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Noto Sans CJK SC","Microsoft YaHei", sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(43,213,118,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    .wrap{max-width:980px; margin:0 auto; padding:20px 16px 28px;}
    .top{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:12px 14px; border:1px solid var(--line); border-radius:14px;
      background: rgba(255,255,255,.03); backdrop-filter: blur(10px);
    }
    .left,.right{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      color:var(--muted); font-size:12px; background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    input, button{
      border-radius:12px; border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:10px 12px; font-size:14px; outline:none;
    }
    input::placeholder{color: rgba(232,234,240,.45);}
    button{cursor:pointer}
    button:active{transform: translateY(1px);}
    .primary{background: rgba(122,162,255,.16); border-color: rgba(122,162,255,.35);}
    .good{background: rgba(43,213,118,.14); border-color: rgba(43,213,118,.35);}
    .again{background: rgba(255,77,79,.12); border-color: rgba(255,77,79,.35);}
    .card{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding:18px;
    }
    .frontTitle{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      padding-bottom:10px; border-bottom:1px solid var(--line);
    }
    .verb{font-size:20px; font-weight:680; margin:0;}
    .sub{color:var(--muted); font-size:13px; margin-top:4px;}
    .q{margin-top:14px; font-size:18px; letter-spacing:.2px;}
    .answerRow{margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .answerRow input{flex:1 1 320px;}
    .msg{margin-top:10px; color: var(--muted); font-size:13px; min-height:18px;}
    .msg.ok{color: var(--good);}
    .msg.bad{color: var(--bad);}
    .back{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
      color: var(--muted);
      font-size:14px;
      display:none;
    }
    .back b{color: var(--text);}
    .miniTable{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 14px;
      padding: 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.22);
    }
    .kv{display:flex; gap:10px; align-items:baseline;}
    .k{color: rgba(232,234,240,.55); width: 92px;}
    .v{color: var(--text); font-weight: 620;}
    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .actions .leftBtn{display:flex; gap:10px; flex-wrap:wrap;}
    .hint{color: rgba(232,234,240,.55); font-size:13px;}
    .small{font-size:12px; color: rgba(232,234,240,.48); margin-top:12px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="left">
      <span class="pill" id="deckInfo">题目：0 / 0</span>
      <span class="pill">规则：总题数 = 词数 × 6</span>
      <input id="search" placeholder="搜索：aimer / 喜欢 / prends / me lève ..." />
    </div>
    <div class="right">
      <button id="reset" title="清空进度">重置进度</button>
      <button id="shuffle" class="primary">打乱</button>
    </div>
  </div>

  <div class="card" id="card"></div>

  <div class="small">
    快捷键：Enter=提交/翻面；1=Again；2=Good；←/→=上一题/下一题（仅浏览）
  </div>
</div>

<script>
/* ===== 动词表（présent） ===== */
const CARDS = [
  {id:"aimer", infinitive:"aimer", meaning:"喜欢", type:"regular", forms:{je:"aime", tu:"aimes", "il/elle/on":"aime", nous:"aimons", vous:"aimez", "ils/elles":"aiment"}},
  {id:"parler", infinitive:"parler", meaning:"说话", type:"regular", forms:{je:"parle", tu:"parles", "il/elle/on":"parle", nous:"parlons", vous:"parlez", "ils/elles":"parlent"}},
  {id:"travailler", infinitive:"travailler", meaning:"工作", type:"regular", forms:{je:"travaille", tu:"travailles", "il/elle/on":"travaille", nous:"travaillons", vous:"travaillez", "ils/elles":"travaillent"}},
  {id:"profiter", infinitive:"profiter", meaning:"享受", type:"regular", forms:{je:"profite", tu:"profites", "il/elle/on":"profite", nous:"profitons", vous:"profitez", "ils/elles":"profitent"}},
  {id:"visiter", infinitive:"visiter", meaning:"参观", type:"regular", forms:{je:"visite", tu:"visites", "il/elle/on":"visite", nous:"visitons", vous:"visitez", "ils/elles":"visitent"}},
  {id:"écouter", infinitive:"écouter", meaning:"听", type:"regular", forms:{je:"écoute", tu:"écoutes", "il/elle/on":"écoute", nous:"écoutons", vous:"écoutez", "ils/elles":"écoutent"}},
  {id:"inviter", infinitive:"inviter", meaning:"邀请", type:"regular", forms:{je:"invite", tu:"invites", "il/elle/on":"invite", nous:"invitons", vous:"invitez", "ils/elles":"invitent"}},
  {id:"aider", infinitive:"aider", meaning:"帮助", type:"regular", forms:{je:"aide", tu:"aides", "il/elle/on":"aide", nous:"aidons", vous:"aidez", "ils/elles":"aident"}},
  {id:"habiter", infinitive:"habiter", meaning:"居住", type:"regular", forms:{je:"habite", tu:"habites", "il/elle/on":"habite", nous:"habitons", vous:"habitez", "ils/elles":"habitent"}},
  {id:"monter", infinitive:"monter", meaning:"上去", type:"regular", forms:{je:"monte", tu:"montes", "il/elle/on":"monte", nous:"montons", vous:"montez", "ils/elles":"montent"}},
  {id:"louer", infinitive:"louer", meaning:"租", type:"regular", forms:{je:"loue", tu:"loues", "il/elle/on":"loue", nous:"louons", vous:"louez", "ils/elles":"louent"}},
  {id:"indiquer", infinitive:"indiquer", meaning:"指出", type:"regular", forms:{je:"indique", tu:"indiques", "il/elle/on":"indique", nous:"indiquons", vous:"indiquez", "ils/elles":"indiquent"}},
  {id:"téléphoner", infinitive:"téléphoner", meaning:"打电话", type:"regular", forms:{je:"téléphone", tu:"téléphones", "il/elle/on":"téléphone", nous:"téléphonons", vous:"téléphonez", "ils/elles":"téléphonent"}},
  {id:"voyager", infinitive:"voyager", meaning:"旅行", type:"regular", forms:{je:"voyage", tu:"voyages", "il/elle/on":"voyage", nous:"voyageons", vous:"voyagez", "ils/elles":"voyagent"}},
  {id:"regarder", infinitive:"regarder", meaning:"看", type:"regular", forms:{je:"regarde", tu:"regardes", "il/elle/on":"regarde", nous:"regardons", vous:"regardez", "ils/elles":"regardent"}},
  {id:"passer", infinitive:"passer", meaning:"经过", type:"regular", forms:{je:"passe", tu:"passes", "il/elle/on":"passe", nous:"passons", vous:"passez", "ils/elles":"passent"}},
  {id:"donner", infinitive:"donner", meaning:"给", type:"regular", forms:{je:"donne", tu:"donnes", "il/elle/on":"donne", nous:"donnons", vous:"donnez", "ils/elles":"donnent"}},
  {id:"redoubler", infinitive:"redoubler", meaning:"重修", type:"regular", forms:{je:"redouble", tu:"redoubles", "il/elle/on":"redouble", nous:"redoublons", vous:"redoublez", "ils/elles":"redoublent"}},
  {id:"trouver", infinitive:"trouver", meaning:"找到", type:"regular", forms:{je:"trouve", tu:"trouves", "il/elle/on":"trouve", nous:"trouvons", vous:"trouvez", "ils/elles":"trouvent"}},
  {id:"rencontrer", infinitive:"rencontrer", meaning:"遇见", type:"regular", forms:{je:"rencontre", tu:"rencontres", "il/elle/on":"rencontre", nous:"rencontrons", vous:"rencontrez", "ils/elles":"rencontrent"}},
  {id:"retourner", infinitive:"retourner", meaning:"返回", type:"regular", forms:{je:"retourne", tu:"retournes", "il/elle/on":"retourne", nous:"retournons", vous:"retournez", "ils/elles":"retournent"}},
  {id:"laisser", infinitive:"laisser", meaning:"留下", type:"regular", forms:{je:"laisse", tu:"laisses", "il/elle/on":"laisse", nous:"laissons", vous:"laissez", "ils/elles":"laissent"}},
  {id:"prier", infinitive:"prier", meaning:"祈祷", type:"regular", forms:{je:"prie", tu:"pries", "il/elle/on":"prie", nous:"prions", vous:"priez", "ils/elles":"prient"}},
  {id:"présenter", infinitive:"présenter", meaning:"介绍", type:"regular", forms:{je:"présente", tu:"présentes", "il/elle/on":"présente", nous:"présentons", vous:"présentez", "ils/elles":"présentent"}},
  {id:"fumer", infinitive:"fumer", meaning:"抽烟", type:"regular", forms:{je:"fume", tu:"fumes", "il/elle/on":"fume", nous:"fumons", vous:"fumez", "ils/elles":"fument"}},
  {id:"refuser", infinitive:"refuser", meaning:"拒绝", type:"regular", forms:{je:"refuse", tu:"refuses", "il/elle/on":"refuse", nous:"refusons", vous:"refusez", "ils/elles":"refusent"}},
  {id:"accepter", infinitive:"accepter", meaning:"接受", type:"regular", forms:{je:"accepte", tu:"acceptes", "il/elle/on":"accepte", nous:"acceptons", vous:"acceptez", "ils/elles":"acceptent"}},
  {id:"offrir", infinitive:"offrir", meaning:"提供", type:"irregular", forms:{je:"offre", tu:"offres", "il/elle/on":"offre", nous:"offrons", vous:"offrez", "ils/elles":"offrent"}},
  {id:"s_adresser", infinitive:"s’adresser", meaning:"致使/求助", type:"reflexive", forms:{je:"m’adresse", tu:"t’adresses", "il/elle/on":"s’adresse", nous:"nous adressons", vous:"vous adressez", "ils/elles":"s’adressent"}},
  {id:"se_lever", infinitive:"se lever", meaning:"起床", type:"reflexive", forms:{je:"me lève", tu:"te lèves", "il/elle/on":"se lève", nous:"nous levons", vous:"vous levez", "ils/elles":"se lèvent"}},
  {id:"se_coucher", infinitive:"se coucher", meaning:"睡觉", type:"reflexive", forms:{je:"me couche", tu:"te couches", "il/elle/on":"se couche", nous:"nous couchons", vous:"vous couchez", "ils/elles":"se couchent"}},
  {id:"prendre", infinitive:"prendre", meaning:"拿", type:"irregular", forms:{je:"prends", tu:"prends", "il/elle/on":"prend", nous:"prenons", vous:"prenez", "ils/elles":"prennent"}},
  {id:"apprendre", infinitive:"apprendre", meaning:"学习", type:"irregular", forms:{je:"apprends", tu:"apprends", "il/elle/on":"apprend", nous:"apprenons", vous:"apprenez", "ils/elles":"apprennent"}},
  {id:"comprendre", infinitive:"comprendre", meaning:"理解", type:"irregular", forms:{je:"comprends", tu:"comprends", "il/elle/on":"comprend", nous:"comprenons", vous:"comprenez", "ils/elles":"comprennent"}},
  {id:"venir", infinitive:"venir", meaning:"来", type:"irregular", forms:{je:"viens", tu:"viens", "il/elle/on":"vient", nous:"venons", vous:"venez", "ils/elles":"viennent"}},
  {id:"devenir", infinitive:"devenir", meaning:"成为", type:"irregular", forms:{je:"deviens", tu:"deviens", "il/elle/on":"devient", nous:"devenons", vous:"devenez", "ils/elles":"deviennent"}},
  {id:"aller", infinitive:"aller", meaning:"去", type:"irregular", forms:{je:"vais", tu:"vas", "il/elle/on":"va", nous:"allons", vous:"allez", "ils/elles":"vont"}},
  {id:"faire", infinitive:"faire", meaning:"做", type:"irregular", forms:{je:"fais", tu:"fais", "il/elle/on":"fait", nous:"faisons", vous:"faites", "ils/elles":"font"}},
  {id:"vouloir", infinitive:"vouloir", meaning:"想要", type:"irregular", forms:{je:"veux", tu:"veux", "il/elle/on":"veut", nous:"voulons", vous:"voulez", "ils/elles":"veulent"}},
  {id:"pouvoir", infinitive:"pouvoir", meaning:"能够", type:"irregular", forms:{je:"peux", tu:"peux", "il/elle/on":"peut", nous:"pouvons", vous:"pouvez", "ils/elles":"peuvent"}},
  {id:"savoir", infinitive:"savoir", meaning:"知道", type:"irregular", forms:{je:"sais", tu:"sais", "il/elle/on":"sait", nous:"savons", vous:"savez", "ils/elles":"savent"}},
  {id:"connaître", infinitive:"connaître", meaning:"认识", type:"irregular", forms:{je:"connais", tu:"connais", "il/elle/on":"connaît", nous:"connaissons", vous:"connaissez", "ils/elles":"connaissent"}},
  {id:"voir", infinitive:"voir", meaning:"看见", type:"irregular", forms:{je:"vois", tu:"vois", "il/elle/on":"voit", nous:"voyons", vous:"voyez", "ils/elles":"voient"}},
  {id:"recevoir", infinitive:"recevoir", meaning:"收到", type:"irregular", forms:{je:"reçois", tu:"reçois", "il/elle/on":"reçoit", nous:"recevons", vous:"recevez", "ils/elles":"reçoivent"}},
  {id:"lire", infinitive:"lire", meaning:"读", type:"irregular", forms:{je:"lis", tu:"lis", "il/elle/on":"lit", nous:"lisons", vous:"lisez", "ils/elles":"lisent"}},
  {id:"écrire", infinitive:"écrire", meaning:"写", type:"irregular", forms:{je:"écris", tu:"écris", "il/elle/on":"écrit", nous:"écrivons", vous:"écrivez", "ils/elles":"écrivent"}},
  {id:"suivre", infinitive:"suivre", meaning:"跟随", type:"irregular", forms:{je:"suis", tu:"suis", "il/elle/on":"suit", nous:"suivons", vous:"suivez", "ils/elles":"suivent"}},
  {id:"poursuivre", infinitive:"poursuivre", meaning:"继续", type:"irregular", forms:{je:"poursuis", tu:"poursuis", "il/elle/on":"poursuit", nous:"poursuivons", vous:"poursuivez", "ils/elles":"poursuivent"}},
  {id:"partir", infinitive:"partir", meaning:"离开", type:"irregular", forms:{je:"pars", tu:"pars", "il/elle/on":"part", nous:"partons", vous:"partez", "ils/elles":"partent"}},
  {id:"sortir", infinitive:"sortir", meaning:"出去", type:"irregular", forms:{je:"sors", tu:"sors", "il/elle/on":"sort", nous:"sortons", vous:"sortez", "ils/elles":"sortent"}},
  {id:"réussir", infinitive:"réussir", meaning:"成功", type:"regular", forms:{je:"réussis", tu:"réussis", "il/elle/on":"réussit", nous:"réussissons", vous:"réussissez", "ils/elles":"réussissent"}},
];

const SUBJECTS = ["je","tu","il/elle/on","nous","vous","ils/elles"];
const LS_KEY = "fr_anki_conj_only_v2_human_sent";

/* ===== A1 句子库：每个动词 6 条（对应 6 人称） ===== */
const SENT = {
  aimer:      ["____ le café.", "____ le chocolat.", "____ cette musique.", "____ les films.", "____ le thé ?", "____ la pizza."],
  parler:     ["____ français.", "____ anglais.", "____ avec Marie.", "____ ensemble.", "____ trop vite.", "____ en classe."],
  travailler: ["____ au bureau.", "____ ici.", "____ le matin.", "____ à Paris.", "____ aujourd’hui ?", "____ le week-end."],
  profiter:   ["____ du week-end.", "____ du soleil.", "____ de la fête.", "____ des vacances.", "____ du temps libre.", "____ du voyage."],
  visiter:    ["____ Paris.", "____ un musée.", "____ la ville.", "____ un château.", "____ la Tour Eiffel.", "____ un village."],
  "écouter":  ["____ la radio.", "____ la musique.", "____ le professeur.", "____ un podcast.", "____ cette chanson.", "____ la télé."],
  inviter:    ["____ mon ami.", "____ ta sœur.", "____ Paul.", "____ nos voisins.", "____ vos amis.", "____ Marie."],
  aider:      ["____ mon frère.", "____ ta mère.", "____ un ami.", "____ nos parents.", "____ vos collègues.", "____ leurs amis."],
  habiter:    ["____ à Shanghai.", "____ à Pékin.", "____ en France.", "____ en ville.", "____ ici.", "____ au Canada."],
  monter:     ["____ les escaliers.", "____ dans le bus.", "____ au premier étage.", "____ dans la voiture.", "____ là-haut.", "____ sur la scène."],
  louer:      ["____ un appartement.", "____ une voiture.", "____ un studio.", "____ une maison.", "____ une chambre.", "____ des vélos."],
  indiquer:   ["____ la rue.", "____ le chemin.", "____ la station.", "____ l’adresse.", "____ le numéro.", "____ la sortie."],
  "téléphoner":["____ à ma mère.", "____ à ton ami.", "____ à Marie.", "____ à nos parents.", "____ au bureau.", "____ à leurs amis."],
  voyager:    ["____ en train.", "____ en bus.", "____ en Europe.", "____ en France.", "____ souvent.", "____ en été."],
  regarder:   ["____ un film.", "____ la télé.", "____ le match.", "____ une série.", "____ cette photo.", "____ le ciel."],
  passer:     ["____ par ici.", "____ devant l’école.", "____ à la maison.", "____ au supermarché.", "____ par la gare.", "____ chez moi."],
  donner:     ["____ un livre à Paul.", "____ un stylo.", "____ un conseil.", "____ un cadeau.", "____ mon numéro.", "____ des fleurs."],
  redoubler:  ["____ une année.", "____ cette classe.", "____ le cours.", "____ la première année.", "____ l’examen ?", "____ la matière."],
  trouver:    ["____ la clé.", "____ mon téléphone.", "____ la solution.", "____ une idée.", "____ un restaurant.", "____ la gare."],
  rencontrer: ["____ Marie.", "____ le professeur.", "____ un ami.", "____ des collègues.", "____ le directeur.", "____ leurs amis."],
  retourner:  ["____ à la maison.", "____ au travail.", "____ en ville.", "____ à l’école.", "____ au bureau.", "____ au cinéma."],
  laisser:    ["____ mon sac ici.", "____ un message.", "____ la porte ouverte.", "____ un mot.", "____ votre manteau.", "____ la voiture."],
  prier:      ["____ en silence.", "____ à l’église.", "____ pour la paix.", "____ ensemble.", "____ ici.", "____ le soir."],
  "présenter":["____ mon ami.", "____ ta sœur.", "____ le projet.", "____ la classe.", "____ la famille.", "____ le professeur."],
  fumer:      ["____ rarement.", "____ dehors.", "____ ici.", "____ après le repas.", "____ ?", "____ dans le parc."],
  refuser:    ["____ ce café.", "____ ce gâteau.", "____ l’offre.", "____ la proposition.", "____ cette idée.", "____ l’invitation."],
  accepter:   ["____ la proposition.", "____ l’idée.", "____ le cadeau.", "____ l’invitation.", "____ le projet.", "____ la demande."],
  offrir:     ["____ un cadeau.", "____ un café.", "____ de l’aide.", "____ des fleurs.", "____ un livre.", "____ un dîner."],

  s_adresser: ["____ au professeur.", "____ à la police.", "____ au médecin.", "____ au bureau.", "____ au directeur.", "____ au service."],
  se_lever:   ["____ à sept heures.", "____ tôt.", "____ à huit heures.", "____ à six heures.", "____ tard.", "____ le matin."],
  se_coucher: ["____ tôt.", "____ tard.", "____ à dix heures.", "____ à onze heures.", "____ maintenant.", "____ après le film."],

  prendre:    ["____ un café.", "____ le métro.", "____ une photo.", "____ le bus.", "____ un taxi.", "____ un sandwich."],
  apprendre:  ["____ le français.", "____ les mots.", "____ la leçon.", "____ la grammaire.", "____ vite.", "____ en classe."],
  comprendre: ["____ la question.", "____ bien.", "____ le problème.", "____ la leçon.", "____ ?", "____ tout."],
  venir:      ["____ ici.", "____ avec moi.", "____ demain.", "____ à la maison.", "____ ce soir.", "____ maintenant."],
  devenir:    ["____ professeur.", "____ médecin.", "____ adulte.", "____ amis.", "____ célèbre.", "____ étudiants."],

  aller:      ["____ à l’école.", "____ au cinéma.", "____ à Paris.", "____ au restaurant.", "____ au travail.", "____ à la maison."],
  faire:      ["____ du sport.", "____ les courses.", "____ la cuisine.", "____ un gâteau.", "____ une photo.", "____ les devoirs."],
  vouloir:    ["____ un café.", "____ une eau.", "____ venir ?", "____ partir.", "____ un thé.", "____ manger."],
  pouvoir:    ["____ venir.", "____ m’aider ?", "____ entrer ?", "____ parler.", "____ répéter ?", "____ rester."],
  savoir:     ["____ la réponse.", "____ où c’est ?", "____ son nom.", "____ la vérité.", "____ ?", "____ le chemin."],
  "connaître":["____ cette ville.", "____ Marie ?", "____ le quartier.", "____ la culture.", "____ ce professeur ?", "____ leurs amis."],
  voir:       ["____ la tour.", "____ la mer.", "____ le film.", "____ un chien.", "____ la photo.", "____ la montagne."],
  recevoir:   ["____ une lettre.", "____ un message.", "____ un cadeau.", "____ des nouvelles.", "____ un e-mail.", "____ des appels."],
  lire:       ["____ un livre.", "____ le journal.", "____ la notice.", "____ un roman.", "____ ce texte.", "____ des BD."],
  "écrire":   ["____ une carte.", "____ un e-mail.", "____ une lettre.", "____ un message.", "____ ton nom.", "____ des textes."],
  suivre:     ["____ le cours.", "____ le guide.", "____ la route.", "____ la leçon.", "____ la règle.", "____ le professeur."],
  poursuivre: ["____ mes études.", "____ la discussion.", "____ le travail.", "____ le projet.", "____ ?", "____ la route."],
  partir:     ["____ à huit heures.", "____ maintenant.", "____ ce soir.", "____ demain.", "____ tôt.", "____ ensemble."],
  sortir:     ["____ avec des amis.", "____ ce soir.", "____ maintenant.", "____ après le cours.", "____ ?", "____ le week-end."],
  "réussir":  ["____ l’examen.", "____ le test.", "____ le projet.", "____ le travail.", "____ facilement.", "____ à l’école."],
};

/* ===== 工具 ===== */
const norm = s => (s||"").trim().replace(/\s+/g," ").replaceAll("’","'").toLowerCase();
const esc  = s => (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
function isVowelSound(s){ return /^[aeiouyàâäéèêëïîôöùûüœh]/i.test((s||"").trim()); }
function subjLabel(subj, answer){
  if(subj === "je") return isVowelSound(answer) ? "J’" : "Je";
  if(subj === "tu") return "Tu";
  if(subj === "nous") return "Nous";
  if(subj === "vous") return "Vous";
  if(subj === "il/elle/on") return "Il";
  if(subj === "ils/elles") return "Ils";
  return "Je";
}
function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch(e){ return {}; } }
function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

let state = loadState(); // { [itemId]: {seen:number, box:number} }
function getP(itemId){ return state[itemId] || {seen:0, box:0}; }
function setP(itemId, p){ state[itemId]=p; saveState(state); }

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ===== 题库：严格 词数×6 ===== */
function buildItems(){
  const items = [];
  for(const c of CARDS){
    const sents = SENT[c.id] || ["____ .","____ .","____ .","____ .","____ ?","____ ."];
    for(let i=0;i<SUBJECTS.length;i++){
      const subj = SUBJECTS[i];
      const ans = c.forms[subj];
      const S = subjLabel(subj, ans);
      const sentence = `${S} ${sents[i]}`.replace(/\s+/g," ").trim();
      items.push({
        itemId: `conj:${c.id}:${subj}`,
        verbId: c.id,
        infinitive: c.infinitive,
        meaning: c.meaning,
        subject: subj,
        sentence,
        answer: ans,
      });
    }
  }
  return items;
}

/* ===== 队列：全覆盖优先 + box 复习 ===== */
let itemsAll = buildItems();
let queue = [];
let idx = 0;
let revealed = false;
let shuffled = false;

const $card = document.getElementById("card");
const $deckInfo = document.getElementById("deckInfo");
const $search = document.getElementById("search");

function rebuildQueue(){
  const q = ($search.value||"").trim().toLowerCase();

  const view = itemsAll.filter(it => {
    if(!q) return true;
    const hit = `${it.infinitive} ${it.meaning} ${it.subject} ${it.sentence} ${it.answer}`.toLowerCase();
    return hit.includes(q);
  });

  queue = view.slice().sort((a,b)=>{
    const pa = getP(a.itemId), pb = getP(b.itemId);
    if(pa.seen !== pb.seen) return pa.seen - pb.seen;
    if(pa.box !== pb.box) return pa.box - pb.box;
    return a.itemId.localeCompare(b.itemId);
  });

  if(shuffled) queue = shuffle(queue);

  idx = 0;
  revealed = false;
  render();
  updateTop();
}

function updateTop(){
  const total = queue.length;
  if(total === 0){ $deckInfo.textContent = "题目：0 / 0"; return; }
  const done = queue.filter(it => getP(it.itemId).seen > 0).length;
  const unseen = queue.filter(it => getP(it.itemId).seen === 0).length;
  $deckInfo.textContent = `题目：${idx+1} / ${total} ｜ 未做完：${unseen} ｜ 已做：${done}`;
}

function current(){ return queue[idx] || null; }

function render(){
  const it = current();
  if(!it){ $card.innerHTML = `<div style="color:var(--muted)">没有匹配到题目。</div>`; return; }

  const p = getP(it.itemId);
  const verbLine = `${it.infinitive}（${it.meaning}）`;
  const boxTag = `Box ${p.box}`;

  $card.innerHTML = `
    <div class="frontTitle">
      <div>
        <p class="verb">${esc(verbLine)}</p>
        <div class="sub">présent ｜ 变位 ｜ ${boxTag}</div>
      </div>
      <div class="pill">${it.subject}</div>
    </div>

    <div class="q">${esc(it.sentence)}</div>

    <div class="answerRow">
      <input id="ans" autocomplete="off" placeholder="输入答案（只填动词形式）" />
      <button id="check" class="primary">提交 / 翻面</button>
    </div>

    <div class="msg" id="msg"></div>

    <div class="back" id="back"></div>

    <div class="actions">
      <div class="leftBtn">
        <button id="again" class="again" disabled>Again（1）</button>
        <button id="good" class="good" disabled>Good（2）</button>
      </div>
      <div class="hint">答对会自动 Good 并跳下一题；答错需要你选 Again/Good。</div>
    </div>
  `;

  const $ans = document.getElementById("ans");
  const $check = document.getElementById("check");
  const $msg = document.getElementById("msg");
  const $back = document.getElementById("back");
  const $again = document.getElementById("again");
  const $good = document.getElementById("good");

  $ans.focus();

  function miniKV(k,v){
    return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`;
  }

  function showBack(isCorrect, user){
    revealed = true;

    $msg.textContent = isCorrect ? "对。" : `不对。你的答案：${user || "（空）"}`;
    $msg.className = "msg " + (isCorrect ? "ok" : "bad");

    const cardObj = CARDS.find(c=>c.id===it.verbId);
    const f = cardObj.forms;

    $back.style.display = "block";
    $back.innerHTML = `
      <div>正确答案：<b>${esc(it.answer)}</b></div>
      <div class="miniTable">
        ${miniKV("je", f["je"])}
        ${miniKV("tu", f["tu"])}
        ${miniKV("il/elle/on", f["il/elle/on"])}
        ${miniKV("nous", f["nous"])}
        ${miniKV("vous", f["vous"])}
        ${miniKV("ils/elles", f["ils/elles"])}
      </div>
    `;

    $again.disabled = false;
    $good.disabled = false;
  }

  function grade(isGood){
    const p2 = getP(it.itemId);
    if(isGood) p2.box = Math.min(4, p2.box + 1);
    else p2.box = 0;
    setP(it.itemId, p2);
    next();
  }

  function next(){
    if(queue.length === 0) return;
    idx = (idx + 1) % queue.length;
    revealed = false;
    render();
    updateTop();
  }
  function prev(){
    if(queue.length === 0) return;
    idx = (idx - 1 + queue.length) % queue.length;
    revealed = false;
    render();
    updateTop();
  }

  function check(){
    const userRaw = ($ans.value || "").trim();
    const user = norm(userRaw);
    const ok = user && user === norm(it.answer);

    const p0 = getP(it.itemId);
    p0.seen += 1;
    setP(it.itemId, p0);

    showBack(!!ok, userRaw);

    // 答对：自动 Good + 下一题
    if(ok){
      const p2 = getP(it.itemId);
      p2.box = Math.min(4, p2.box + 1);
      setP(it.itemId, p2);
      setTimeout(()=>{ next(); }, 220);
    }
  }

  $check.addEventListener("click", ()=>{ if(!revealed) check(); });
  $ans.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      if(!revealed) check();
    }
  });

  $again.addEventListener("click", ()=>grade(false));
  $good.addEventListener("click", ()=>grade(true));

  window.__navPrev = prev;
  window.__navNext = next;
}

document.getElementById("shuffle").addEventListener("click", ()=>{
  shuffled = !shuffled;
  rebuildQueue();
});
document.getElementById("reset").addEventListener("click", ()=>{
  localStorage.removeItem(LS_KEY);
  state = {};
  rebuildQueue();
});
$search.addEventListener("input", ()=>{
  clearTimeout(window.__t);
  window.__t = setTimeout(rebuildQueue, 120);
});

document.addEventListener("keydown", (e)=>{
  if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")) return;
  if(e.key === "ArrowLeft") window.__navPrev && window.__navPrev();
  if(e.key === "ArrowRight") window.__navNext && window.__navNext();
  if(e.key === "1"){
    const btn = document.getElementById("again");
    if(btn && !btn.disabled) btn.click();
  }
  if(e.key === "2"){
    const btn = document.getElementById("good");
    if(btn && !btn.disabled) btn.click();
  }
});

rebuildQueue();
</script>
</body>
</html>
